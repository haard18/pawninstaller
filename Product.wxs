<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  
  <Package Name="WhiteBeard Pawn Plugin"
           Language="1033"
           Version="1.0.0"
           Manufacturer="WhiteBeard"
           UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- WixUI variables -->
    <WixVariable Id="WixUICostingPopupOptOut" Value="1" />

    <!-- Custom properties for license and MT5 detection -->
    <Property Id="LICENSEFILE" Secure="yes" />
    <Property Id="COMPANYNAME" Secure="yes" />
    <Property Id="COMPANYEMAIL" Secure="yes" />
    <Property Id="LICENSEVALID" Secure="yes" Value="0" />
    <Property Id="MT5DIRECTORY" Secure="yes" />
    <Property Id="HASADMINPRIVILEGES" Secure="yes" Value="0" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- Custom action DLL reference -->
    <Binary Id="CustomActionsBinary" SourceFile="$(var.CustomActions.TargetDir)$(var.CustomActions.TargetName).dll" />
    
    <!-- Custom Actions -->
    <CustomAction Id="CA_CheckAdminPrivileges" 
                  BinaryRef="CustomActionsBinary" 
                  DllEntry="CheckAdminPrivileges" 
                  Execute="immediate" 
                  Return="ignore" />
    
    <CustomAction Id="CA_SearchLicenseFile" 
                  BinaryRef="CustomActionsBinary" 
                  DllEntry="SearchLicenseFile" 
                  Execute="immediate" 
                  Return="ignore" />
    
    <CustomAction Id="CA_ValidateLicense" 
                  BinaryRef="CustomActionsBinary" 
                  DllEntry="ValidateLicense" 
                  Execute="immediate" 
                  Return="ignore" />
    
    <CustomAction Id="CA_DetectMT5Installation" 
                  BinaryRef="CustomActionsBinary" 
                  DllEntry="DetectMT5Installation" 
                  Execute="immediate" 
                  Return="ignore" />
    
    <CustomAction Id="CA_CopyPluginFiles" 
                  BinaryRef="CustomActionsBinary" 
                  DllEntry="CopyPluginFiles" 
                  Execute="deferred" 
                  Impersonate="no"
                  Return="ignore" />
    
    <!-- Installation sequence -->
    <InstallUISequence>
      <Custom Action="CA_CheckAdminPrivileges" After="LaunchConditions" Condition="NOT Installed" />
      <Custom Action="CA_SearchLicenseFile" After="CA_CheckAdminPrivileges" Condition="NOT Installed" />
      <Custom Action="CA_DetectMT5Installation" After="CA_SearchLicenseFile" Condition="NOT Installed" />
    </InstallUISequence>
    
    <InstallExecuteSequence>
      <Custom Action="CA_CheckAdminPrivileges" After="LaunchConditions" Condition="NOT Installed" />
      <Custom Action="CA_CopyPluginFiles" Before="InstallFinalize" Condition="NOT Installed AND LICENSEVALID=&quot;1&quot;" />
    </InstallExecuteSequence>

    <!-- UI Reference -->
    <UIRef Id="CustomInstallUI" />
    
    <!-- Features -->
    <Feature Id="ProductFeature" Title="WhiteBeard Pawn Plugin" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="LicenseComponents" />
    </Feature>
  </Package>

  <!-- Directory Structure -->
  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="ManufacturerFolder" Name="WhiteBeard">
        <Directory Id="INSTALLFOLDER" Name="WhiteBeard Pawn Plugin" />
      </Directory>
    </StandardDirectory>
      
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="WhiteBeardDataFolder" Name="WhiteBeard" />
    </StandardDirectory>
      
<StandardDirectory Id="ProgramFiles64Folder">
  <Directory Id="MT5InstallFolder" Name="MetaTrader 5">
    <Directory Id="MT5PluginsFolder" Name="Plugins" />
  </Directory>
</StandardDirectory>
  </Fragment>

  <!-- Components -->
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="PawnPluginDLL" Guid="B1C2D3E4-F5A6-7B8C-9D0E-1F2A3B4C5D6E">
        <File Id="PawnPlugin64DLL" Source="Payload\PawnPlugin64.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <ComponentGroup Id="LicenseComponents" Directory="WhiteBeardDataFolder">
      <Component Id="LicenseFileComponent" Guid="C2D3E4F5-A6B7-8C9D-0E1F-2A3B4C5D6E7F">
        <CreateFolder />
        <!-- License file will be copied by custom action -->
        <RemoveFolder Id="RemoveWhiteBeardDataFolder" On="uninstall" />
        <RegistryValue Root="HKLM" 
                       Key="Software\WhiteBeard\PawnPlugin" 
                       Name="LicenseLocation" 
                       Type="string" 
                       Value="[WhiteBeardDataFolder]" 
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
